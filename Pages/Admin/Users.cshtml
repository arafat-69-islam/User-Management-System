@page
@using Demo.Models
@model Demo.Pages.Admin.UsersModel

@{
    ViewData["Title"] = "User Management";
}

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3>User Management</h3>
        <div class="d-flex gap-2">
            <input type="text" id="filterInput" class="form-control" placeholder="Filter" style="width: 200px;">
            <div class="btn-group">
                <button type="button" class="btn btn-danger" id="blockUsers">
                    <i class="fas fa-ban"></i> Block
                </button>
                <button type="button" class="btn btn-success" id="unblockUsers">
                    <i class="fas fa-check"></i> Unblock
                </button>
                <button type="button" class="btn btn-danger" id="deleteUsers">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
    
    <div class="card-body">
        @if (!string.IsNullOrEmpty(Model.Message))
        {
            <div class="alert alert-success">@Model.Message</div>
        }
        @if (!string.IsNullOrEmpty(Model.Error))
        {
            <div class="alert alert-danger">@Model.Error</div>
        }
        
        <form method="post" id="usersForm">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" /></th>
                        <th>
                            Name
                            <button type="button" class="btn btn-sm btn-link p-0" onclick="sortTable(1)">
                                <i class="fas fa-sort"></i>
                            </button>
                        </th>
                        <th>
                            Email
                            <button type="button" class="btn btn-sm btn-link p-0" onclick="sortTable(2)">
                                <i class="fas fa-sort"></i>
                            </button>
                        </th>
                        <th>
                            Last Login
                            <button type="button" class="btn btn-sm btn-link p-0" onclick="sortTable(3)">
                                <i class="fas fa-sort"></i>
                            </button>
                        </th>
                        <th>Status</th>
                        <th>Activity</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    @foreach (var user in Model.Users)
                    {
                        <tr>
                            <td><input type="checkbox" class="user-checkbox" name="userIds" value="@user.Id" /></td>
                            <td>
                                @user.Name
                                @if (!string.IsNullOrEmpty(user.MobileNumber))
                                {
                                    <br><small class="text-muted">@user.MobileNumber</small>
                                }
                            </td>
                            <td>@user.Email</td>
                            <td data-sort="@user.LastLogin.Ticks">
                                @if (user.LastLogin > DateTime.UtcNow.AddMinutes(-1))
                                {
                                    <span>less than a minute ago</span>
                                }
                                else if (user.LastLogin > DateTime.UtcNow.AddMinutes(-5))
                                {
                                    <span>@((int)(DateTime.UtcNow - user.LastLogin).TotalMinutes) minutes ago</span>
                                }
                                else if (user.LastLogin > DateTime.UtcNow.AddDays(-1))
                                {
                                    <span>@user.LastLogin.ToString("HH:mm")</span>
                                }
                                else if (user.LastLogin > DateTime.UtcNow.AddDays(-7))
                                {
                                    <span>@((int)(DateTime.UtcNow - user.LastLogin).TotalDays) days ago</span>
                                }
                                else
                                {
                                    <span>@user.LastLogin.ToString("MMM dd, yyyy")</span>
                                }
                            </td>
                            <td>
                                <span class="badge @(user.Status == UserStatus.Active ? "bg-success" : user.Status == UserStatus.Blocked ? "bg-warning" : "bg-danger")">
                                    @user.Status
                                </span>
                            </td>
                            <td>
                                <div class="activity-chart" data-activity="@GenerateActivityData()"></div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script>
        $(document).ready(function() {
            // Select all checkbox functionality
            $('#selectAll').change(function() {
                $('.user-checkbox').prop('checked', $(this).prop('checked'));
            });

            // Filter functionality
            $('#filterInput').on('keyup', function() {
                var value = $(this).val().toLowerCase();
                $("#usersTableBody tr").filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });

            // Activity charts (simple bar representation)
            $('.activity-chart').each(function() {
                var activity = $(this).data('activity');
                var bars = '';
                for (var i = 0; i < 7; i++) {
                    var height = Math.floor(Math.random() * 20) + 5;
                    bars += '<div style="display:inline-block;width:8px;height:' + height + 'px;background:#007bff;margin:1px;vertical-align:bottom;"></div>';
                }
                $(this).html(bars);
            });

            // Block users
            $('#blockUsers').click(function() {
                if ($('.user-checkbox:checked').length === 0) {
                    alert('Please select at least one user');
                    return;
                }
                $('#usersForm').attr('action', '@Url.Page("", "BlockUsers")').submit();
            });

            // Unblock users
            $('#unblockUsers').click(function() {
                if ($('.user-checkbox:checked').length === 0) {
                    alert('Please select at least one user');
                    return;
                }
                $('#usersForm').attr('action', '@Url.Page("", "UnblockUsers")').submit();
            });

            // Delete users
            $('#deleteUsers').click(function() {
                if ($('.user-checkbox:checked').length === 0) {
                    alert('Please select at least one user');
                    return;
                }
                if (confirm('Are you sure you want to delete the selected users?')) {
                    $('#usersForm').attr('action', '@Url.Page("", "DeleteUsers")').submit();
                }
            });
        });

        // Table sorting functionality
        function sortTable(columnIndex) {
            var table = document.querySelector('table');
            var tbody = table.querySelector('tbody');
            var rows = Array.from(tbody.rows);
            
            var isAscending = table.getAttribute('data-sort-direction') !== 'asc';
            table.setAttribute('data-sort-direction', isAscending ? 'asc' : 'desc');
            
            rows.sort(function(a, b) {
                var aVal = a.cells[columnIndex].textContent.trim();
                var bVal = b.cells[columnIndex].textContent.trim();
                
                // Handle date sorting for Last Login column
                if (columnIndex === 3) {
                    aVal = a.cells[columnIndex].getAttribute('data-sort') || '0';
                    bVal = b.cells[columnIndex].getAttribute('data-sort') || '0';
                    return isAscending ? aVal - bVal : bVal - aVal;
                }
                
                if (aVal < bVal) return isAscending ? -1 : 1;
                if (aVal > bVal) return isAscending ? 1 : -1;
                return 0;
            });
            
            tbody.innerHTML = '';
            rows.forEach(function(row) {
                tbody.appendChild(row);
            });
        }
    </script>
}

@functions {
    string GenerateActivityData()
    {
        // This would normally come from actual user activity data
        return "sample_activity_data";
    }
}